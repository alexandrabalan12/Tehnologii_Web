<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css2?family=Yellowtail&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Jura:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./styles/index.css" />
    <link rel="stylesheet" href="./styles/pages/home.css" />
    <link rel="stylesheet" href="./styles/pages/afterlogin.css" />
    <link rel="stylesheet" href="./styles/pages/account.css" />
    <link rel="stylesheet" href="./styles/pages/aftersignup-company.css" />
    <link rel="stylesheet" href="./styles/pages/applicationpage.css" />
    <link rel="stylesheet" href="./styles/pages/addproject.css" />
    <script src="./scripts/utilites.js"></script>
    <script src="./scripts/navbar.js"></script>
  </head>

  <body>
    <div id="navbar-container"></div>
    <div class="container">
      <h2 class="text-h2-title">Post your project</h2>
      <div class="container">
        <div class="message1">
          <h2 class="text-h3">Name of the project</h2>
          <div class="details-aftersignup">
            <div class="input-group__area">
              <input
                id="name-project"
                name="name-project"
                type="text"
                placeholder="Your answer..."
              />
            </div>
          </div>
        </div>
        <div class="message1">
          <h2 class="text-h3">City of Romania</h2>
          <div class="details-aftersignup">
            <select class="select-standard" name="1A" id="register-location">
							<option value="brasov">Brasov</option>
							<option value="bucuresti">Bucuresti</option>
							<option value="cluj">Cluj</option>
							<option value="iasi">Iasi</option>
							<option value="timisoara">Timisoara</option>
						</select>
          </div>
        </div>
        <div class="message1">
          <h2 class="text-h3">Professional Area in need</h2>
          <div class="details-aftersignup">
            <select class="select-standard" name="1A" id="select-category">
              <option value="interior_design">Interior design</option>
              <option value="masonry">Masonry</option>
              <option value="plumbing">Plumbing</option>
              <option value="roofing">Roofing</option>
              <option value="structural_engineering">
                Structural engineering
              </option>
            </select>
          </div>
        </div>
        <div class="message">
          <h2 class="text-h3">Description</h2>
          <div class="text-body-copy">
            Short description of the project. The clearer you are the better.
          </div>
          <div class="input-group__area">
            <textarea
              id="description"
              name="your-message"
              placeholder="Your message..."
            ></textarea>
          </div>
        </div>
        <div class="additional-info" id="requirements-container">
          <template id="template-requirement">
            <div class="input-group__area-big" data-selector="requirement-child">
              <button data-selector="remove-requirement" class="toggle-requirement-btn">
                <img
                  src="./assets/minus.png"
                  alt="Add a requirement"
                  class="toggle-requirement-icon"
                />
                <span class="toggle-requirement-text"
                  >Remove the technical requirement</span
                >
              </button>
              <h2 class="text-body-copy">Requirement name</h2>
              <div class="input-group__area">
                <input
                  data-selector="requirement-name"
                  name="requirement1-description"
                  type="text"
                  placeholder="Requirement name..."
                />
              </div>
              <h2 class="text-body-copy">Description</h2>
              <div class="input-group__area">
                <input
                  data-selector="requirement-description"
                  name="requirement1-description"
                  type="text"
                  placeholder="Requirement description..."
                />
              </div>
            </div>
          </template>
          <button class="toggle-requirement-btn" id="add-requirement">
            <img
              src="./assets/add.png"
              alt="Add a requirement"
              class="toggle-requirement-icon"
            />
            <span class="toggle-requirement-text"
              >Add technical requirement</span
            >
          </button>
        </div>

        <div class="message1">
          <h2 class="text-h3">Write your budget</h2>
          <div class="details-aftersignup">
            <div class="input-group__area">
              <input
                id="project-budget"
                type="text"
                placeholder="Your answer..."
              />
            </div>
          </div>
        </div>
      </div>
      <div class="save-button">
        <div class="title-itemslong">
          <button class="button-primary" id="create-post"
            >POST</button
          >
        </div>
      </div>
      <h2 class="text-h2">Contact us</h2>
      <div class="contact-info">
        <div class="contact-mail">
          <img src="./assets/email.png" />
          <p class="text-body-copy">emailemail@gmail.com</p>
        </div>
        <div class="contact-phone">
          <img src="./assets/phone.png" />
          <p class="text-body-copy">+407.12.123.123</p>
        </div>
        <div class="contact-adress">
          <img src="./assets/location.png" />
          <p class="text-body-copy">Iasi, Romania</p>
        </div>
      </div>
    </div>
    <script>
			document.addEventListener("DOMContentLoaded", () => {
        const project_name = document.getElementById('name-project');
        const project_location = document.getElementById('register-location');
        const project_professional_area = document.getElementById('select-category');
        const project_price = document.getElementById('project-budget');
        const project_description = document.getElementById('description');

        const requirementTemplate = document.getElementById('template-requirement');
        const requirementContainer = document.getElementById('requirements-container');
        const addRequirement = document.getElementById('add-requirement');

        const savePost = document.getElementById('create-post');

        let requirementIndex = 0;

        function createRequirement() {
          const reqTemplate = document
					.getElementById("template-requirement")
					.content.cloneNode(true).firstElementChild;

          const reqName = reqTemplate.querySelector(
            '[data-selector="requirement-name"]'
          );
          const reqDescription = reqTemplate.querySelector(
            '[data-selector="requirement-description"]'
          );
          const reqRemove = reqTemplate.querySelector(
            '[data-selector="remove-requirement"]'
          );
    
          reqTemplate.id = `req-${requirementIndex}`;
          reqName.id = `req-name-${requirementIndex}`;
          reqDescription.id = `req-description-${requirementIndex}`;
          reqRemove.id = `req-remove-${requirementIndex}`;

          reqRemove.addEventListener('click', () => {
            reqTemplate.remove();
          });

          requirementContainer.appendChild(reqTemplate);
          requirementIndex += 1;
        };

        addRequirement.addEventListener('click', () => createRequirement());

        function createPayload() {
          const userId = localStorage.getItem('userId');

          const payload = {
            user_id: userId,
            name: project_name.value,
            description: project_description.value,
            location: project_location.value,
            price: project_price.value,
            professional_area: project_professional_area.value,
            status: 'open',
            requirements: []
          }

          const requirements = document.querySelectorAll('[data-selector="requirement-child"]');
          requirements.forEach(requirement => {
            const req = {};

            const reqName= requirement.querySelector(
              '[data-selector="requirement-name"]'
            );
            const reqDescription= requirement.querySelector(
              '[data-selector="requirement-description"]'
            );

            req.name = reqName.value;
            req.description = reqDescription.value;

            payload.requirements.push(req);
          });

          return payload;
        };

        async function createPost() {
          const payload = createPayload();
          const token = localStorage.getItem("authToken");

          try {
            const data = await apiRequest(
              `http://localhost:8000/api/client/project-new`,
              "POST",
              payload,
              {
                authorization: token,
                "user-type": "client",
              }
            );

            window.location.href = `http://127.0.0.1:5500/client-projectwithapplicants.html?id=${data.project_id}`;
          } catch (err) {
            console.log(err);
            alert("Error occured, please try later");
          }
        };

        savePost.addEventListener('click', () => createPost());
			});
		</script>
  </body>
</html>
